#!/bin/bash

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if 'uname' command exists
if ! command_exists uname; then
    echo "'uname' command not found. Please ensure you have the necessary tools installed."
    exit 1
fi

# Get the installed kernel version
kernel_version=$(uname -r)
echo "Installed kernel version: $kernel_version"

# Vulnerable kernel version range for CVE-2023-3269
vulnerable_min_version="5.10.0"
vulnerable_max_version="5.10.12"

# Compare function for version strings
version_compare() {
    if [ "$1" = "$2" ]; then
        return 0
    fi

    local IFS=.
    local i version1=($1) version2=($2)

    # Fill empty fields in version1 with zeros
    for ((i=${#version1[@]}; i<${#version2[@]}; i++)); do
        version1[i]=0
    done

    # Fill empty fields in version2 with zeros
    for ((i=${#version2[@]}; i<${#version1[@]}; i++)); do
        version2[i]=0
    done

    for ((i=0; i<${#version1[@]}; i++)); do
        if [ "${version1[i]}" -lt "${version2[i]}" ]; then
            return 1
        elif [ "${version1[i]}" -gt "${version2[i]}" ]; then
            return 2
        fi
    done

    return 0
}

# Check if the installed kernel version is vulnerable
version_compare "$kernel_version" "$vulnerable_min_version"
min_compare=$?

version_compare "$kernel_version" "$vulnerable_max_version"
max_compare=$?

if [ $min_compare -eq 2 ] && [ $max_compare -eq 1 ]; then
    echo "Your system is vulnerable to CVE-2023-3269 (StackRot). Please update your kernel."
else
    echo "Your system is not vulnerable to CVE-2023-3269 (StackRot)."
fi
